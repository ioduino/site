// Generated by CoffeeScript 1.12.5
/*
   Stomp Over WebSocket http://www.jmesnil.net/stomp-websocket/doc/ | Apache License V2.0

   Copyright (C) 2010-2013 [Jeff Mesnil](http://jmesnil.net/)
   Copyright (C) 2012 [FuseSource, Inc.](http://fusesource.com)
 */
(function(){var e,t,n,i,o={}.hasOwnProperty,r=[].slice;e={LF:"\n",NULL:"\0"};n=function(){var t;function n(e,t,n){this.command=e;this.headers=t!=null?t:{};this.body=n!=null?n:""}n.prototype.toString=function(){var t,i,r,s,c;t=[this.command];s=this.headers["content-length"]===false?true:false;if(s){delete this.headers["content-length"]}r=this.headers;for(i in r){if(!o.call(r,i))continue;c=r[i];t.push(i+":"+c)}if(this.body&&!s){t.push("content-length:"+n.sizeOfUTF8(this.body))}t.push(e.LF+this.body);return t.join(e.LF)};n.sizeOfUTF8=function(e){if(e){return encodeURI(e).match(/%..|./g).length}else{return 0}};t=function(t){var i,o,r,s,c,u,a,f,h,d,p,l,g,b,y,v,m,S;s=t.search(RegExp(""+e.LF+e.LF));c=t.substring(0,s).split(e.LF);r=c.shift();u={};S=function(e){return e.replace(/^\s+|\s+$/g,"")};b=c.reverse();for(h=0,l=b.length;h<l;h++){g=b[h];f=g.indexOf(":");u[S(g.substring(0,f))]=S(g.substring(f+1))}i="";m=s+2;if(u["content-length"]){p=parseInt(u["content-length"]);i=(""+t).substring(m,m+p)}else{o=null;for(a=d=y=m,v=t.length;y<=v?d<v:d>v;a=y<=v?++d:--d){o=t.charAt(a);if(o===e.NULL){break}i+=o}}return new n(r,u,i)};n.unmarshall=function(n){var i,o,r,s;o=n.split(RegExp(""+e.NULL+e.LF+"*"));s={frames:[],partial:""};s.frames=function(){var e,n,r,s;r=o.slice(0,-1);s=[];for(e=0,n=r.length;e<n;e++){i=r[e];s.push(t(i))}return s}();r=o.slice(-1)[0];if(r===e.LF||r.search(RegExp(""+e.NULL+e.LF+"*$"))!==-1){s.frames.push(t(r))}else{s.partial=r}return s};n.marshall=function(t,i,o){var r;r=new n(t,i,o);return r.toString()+e.NULL};return n}();t=function(){var t;function o(e){this.ws_fn=function(){var t;t=e();t.binaryType="arraybuffer";return t};this.reconnect_delay=0;this.counter=0;this.reconnecting=0;this.connected=false;this.heartbeat={outgoing:1e4,incoming:1e4};this.maxWebSocketFrameSize=16*1024;this.subscriptions={};this.partialData=""}o.prototype.onReconnect=function(){return typeof this.debug==="function"?this.debug(">>> Reconnecting!"):void 0};o.prototype.onSocketReconnected=function(){return typeof this.debug==="function"?this.debug(">>> Socket Reconnected!"):void 0};o.prototype.onStompReconnected=function(e){return typeof this.debug==="function"?this.debug(">>> Stomp Reconnected!"):void 0};o.prototype.onDisconnected=function(){return typeof this.debug==="function"?this.debug(">>> Disconnected!"):void 0};o.prototype.onSocketConnected=function(){return typeof this.debug==="function"?this.debug(">>> Socket Connected!"):void 0};o.prototype.onStompConnected=function(e){return typeof this.debug==="function"?this.debug(">>> Stomp Connected!"):void 0};o.prototype.debug=function(e){var t;return typeof window!=="undefined"&&window!==null?(t=window.console)!=null?t.log(e):void 0:void 0};t=function(){if(Date.now){return Date.now()}else{return(new Date).valueOf}};o.prototype._transmit=function(e,t,i){var o;o=n.marshall(e,t,i);if(typeof this.debug==="function"){this.debug(">>> "+o)}while(true){if(o.length>this.maxWebSocketFrameSize){this.ws.send(o.substring(0,this.maxWebSocketFrameSize));o=o.substring(this.maxWebSocketFrameSize);if(typeof this.debug==="function"){this.debug("remaining = "+o.length)}}else{return this.ws.send(o)}}};o.prototype._setupHeartbeat=function(n){var o,r,s,c,u,a;if((o=n.version)!==i.VERSIONS.V1_1&&o!==i.VERSIONS.V1_2){return}r=function(){var e,t,i,o;i=n["heart-beat"].split(",");o=[];for(e=0,t=i.length;e<t;e++){a=i[e];o.push(parseInt(a))}return o}(),c=r[0],s=r[1];if(!(this.heartbeat.outgoing===0||s===0)){u=Math.max(this.heartbeat.outgoing,s);if(typeof this.debug==="function"){this.debug("send PING every "+u+"ms")}this.pinger=i.setInterval(u,function(t){return function(){t.ws.send(e.LF);return typeof t.debug==="function"?t.debug(">>> PING"):void 0}}(this))}if(!(this.heartbeat.incoming===0||c===0)){u=Math.max(this.heartbeat.incoming,c);if(typeof this.debug==="function"){this.debug("check PONG every "+u+"ms")}return this.ponger=i.setInterval(u,function(e){return function(){var n;n=t()-e.serverActivity;if(n>u*2){if(typeof e.debug==="function"){e.debug("did not receive server activity for the last "+n+"ms")}return e.ws.close()}}}(this))}};o.prototype._parseConnect=function(){var e,t,n,i;e=1<=arguments.length?r.call(arguments,0):[];i={};switch(e.length){case 2:i=e[0],t=e[1];break;case 3:if(e[1]instanceof Function){i=e[0],t=e[1],n=e[2]}else{i.login=e[0],i.passcode=e[1],t=e[2]}break;case 4:i.login=e[0],i.passcode=e[1],t=e[2],n=e[3];break;default:i.login=e[0],i.passcode=e[1],t=e[2],n=e[3],i.host=e[4]}return[i,t,n]};o.prototype.connect=function(){var e,t;e=1<=arguments.length?r.call(arguments,0):[];t=this._parseConnect.apply(this,e);this.headers=t[0],this.connectCallback=t[1],this.errorCallback=t[2];return this._connect()};o.prototype._connect=function(){var o,r;r=this.headers;o=this.errorCallback;if(typeof this.debug==="function"){this.debug("Opening Web Socket...")}this.ws=this.ws_fn();this.ws.onmessage=function(r){return function(s){var c,u,a,f,h,d,p,l,g,b,y,v,m;f=typeof ArrayBuffer!=="undefined"&&s.data instanceof ArrayBuffer?(c=new Uint8Array(s.data),typeof r.debug==="function"?r.debug("--- got data length: "+c.length):void 0,function(){var e,t,n;n=[];for(e=0,t=c.length;e<t;e++){u=c[e];n.push(String.fromCharCode(u))}return n}().join("")):s.data;r.serverActivity=t();if(f===e.LF){if(typeof r.debug==="function"){r.debug("<<< PONG")}return}if(typeof r.debug==="function"){r.debug("<<< "+f)}m=n.unmarshall(r.partialData+f);r.partialData=m.partial;b=m.frames;y=[];for(d=0,p=b.length;d<p;d++){h=b[d];switch(h.command){case"CONNECTED":if(typeof r.debug==="function"){r.debug("connected to server "+h.headers.server)}r.connected=true;if(r.reconnecting===true){r.reconnecting=false;r.onStompReconnected(h)}r.version=h.headers.version;r._setupHeartbeat(h.headers);r.onStompConnected(h);y.push(typeof r.connectCallback==="function"?r.connectCallback(h):void 0);break;case"MESSAGE":v=h.headers.subscription;g=r.subscriptions[v]||r.onreceive;if(g){a=r;if(r.version===i.VERSIONS.V1_2){l=h.headers["ack"]}else{l=h.headers["message-id"]}h.ack=function(e){if(e==null){e={}}return a.ack(l,v,e)};h.nack=function(e){if(e==null){e={}}return a.nack(l,v,e)};y.push(g(h))}else{y.push(typeof r.debug==="function"?r.debug("Unhandled received MESSAGE: "+h):void 0)}break;case"RECEIPT":if(h.headers["receipt-id"]===r.closeReceipt){r.ws.onclose=null;r.ws.close();y.push(r._cleanUp())}else{y.push(typeof r.onreceipt==="function"?r.onreceipt(h):void 0)}break;case"ERROR":y.push(typeof o==="function"?o(h):void 0);break;default:y.push(typeof r.debug==="function"?r.debug("Unhandled frame: "+h):void 0)}}return y}}(this);this.ws.onclose=function(e){return function(){var t;t="Whoops! Lost connection to "+e.ws.url;if(typeof e.debug==="function"){e.debug(t)}e.onDisconnected();e._cleanUp();if(typeof o==="function"){o(t)}e.connected=false;return e._schedule_reconnect()}}(this);return this.ws.onopen=function(e){return function(){if(typeof e.debug==="function"){e.debug("Web Socket Opened...")}r["accept-version"]=i.VERSIONS.supportedVersions();r["heart-beat"]=[e.heartbeat.outgoing,e.heartbeat.incoming].join(",");e._transmit("CONNECT",r);if(e.reconnecting===true){e.onSocketReconnected()}return e.onSocketConnected()}}(this)};o.prototype._schedule_reconnect=function(){if(this.reconnect_delay>0){this.reconnecting=true;this.debug("STOMP: scheduling reconnection in "+this.reconnect_delay+"ms");return setTimeout(function(e){return function(){if(e.connected){return typeof e.debug==="function"?e.debug("STOMP: already connected"):void 0}else{if(typeof e.debug==="function"){e.debug("STOMP: attempting to reconnect")}e.onReconnect();return e._connect()}}}(this),this.reconnect_delay)}};o.prototype.disconnect=function(e,t){if(t==null){t={}}if(!t.receipt){t.receipt="close-"+this.counter++}this.closeReceipt=t.receipt;this._transmit("DISCONNECT",t);return typeof e==="function"?e():void 0};o.prototype._cleanUp=function(){this.connected=false;this.subscriptions={};this.partial="";if(this.pinger){i.clearInterval(this.pinger)}if(this.ponger){return i.clearInterval(this.ponger)}};o.prototype.send=function(e,t,n){if(t==null){t={}}if(n==null){n=""}t.destination=e;return this._transmit("SEND",t,n)};o.prototype.subscribe=function(e,t,n){var i;if(n==null){n={}}if(!n.id){n.id="sub-"+this.counter++}n.destination=e;this.subscriptions[n.id]=t;this._transmit("SUBSCRIBE",n);i=this;return{id:n.id,unsubscribe:function(e){return i.unsubscribe(n.id,e)}}};o.prototype.unsubscribe=function(e,t){if(t==null){t={}}delete this.subscriptions[e];t.id=e;return this._transmit("UNSUBSCRIBE",t)};o.prototype.begin=function(e){var t,n;n=e||"tx-"+this.counter++;this._transmit("BEGIN",{transaction:n});t=this;return{id:n,commit:function(){return t.commit(n)},abort:function(){return t.abort(n)}}};o.prototype.commit=function(e){return this._transmit("COMMIT",{transaction:e})};o.prototype.abort=function(e){return this._transmit("ABORT",{transaction:e})};o.prototype.ack=function(e,t,n){if(n==null){n={}}if(this.version===i.VERSIONS.V1_2){n["id"]=e}else{n["message-id"]=e}n.subscription=t;return this._transmit("ACK",n)};o.prototype.nack=function(e,t,n){if(n==null){n={}}if(this.version===i.VERSIONS.V1_2){n["id"]=e}else{n["message-id"]=e}n.subscription=t;return this._transmit("NACK",n)};return o}();i={VERSIONS:{V1_0:"1.0",V1_1:"1.1",V1_2:"1.2",supportedVersions:function(){return"1.2,1.1,1.0"}},client:function(e,n){var o;if(n==null){n=["v10.stomp","v11.stomp","v12.stomp"]}o=function(){var t;t=i.WebSocketClass||WebSocket;return new t(e,n)};return new t(o)},over:function(e){var n;n=typeof e==="function"?e:function(){return e};return new t(n)},Frame:n};if(typeof exports!=="undefined"&&exports!==null){exports.Stomp=i}if(typeof window!=="undefined"&&window!==null){i.setInterval=function(e,t){return window.setInterval(t,e)};i.clearInterval=function(e){return window.clearInterval(e)};window.Stomp=i}else if(!exports){self.Stomp=i}}).call(this);